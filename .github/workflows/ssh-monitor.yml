name: SSH Monitor

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: SSH Health Check
      run: |
        HOST="artnests.com"
        PORT="22"
        WEBHOOK_URL="https://open.feishu.cn/open-apis/bot/v2/hook/da5b31b2-5178-4fc0-b8fe-5c69cf5e1a5d"
        FAILED_COUNT=0
        
        for i in {1..3}; do
          # TCPç«¯å£æ£€æµ‹
          if timeout 10 nc -z "$HOST" "$PORT" >/dev/null 2>&1; then
            # SSHåè®®æ¡æ‰‹æ£€æµ‹
            if echo "" | timeout 5 telnet "$HOST" "$PORT" 2>/dev/null | grep -q "SSH"; then
              echo "âœ… SSHæœåŠ¡æ­£å¸¸"
              exit 0
            fi
          fi
          
          FAILED_COUNT=$((FAILED_COUNT + 1))
          echo "âŒ æ£€æµ‹å¤±è´¥ ($i/3)"
          
          [ $i -eq 1 ] && sleep 5
          [ $i -eq 2 ] && sleep 30
        done
        
        # å‘é€å‘Šè­¦
        if [ $FAILED_COUNT -eq 3 ]; then
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          MESSAGE="{
            \"msg_type\": \"text\",
            \"content\": {
              \"text\": \"ğŸš¨ SSHæœåŠ¡å¼‚å¸¸\\n\\nçŠ¶æ€: è¿æ¥å¤±è´¥\\næ—¶é—´: $CURRENT_TIME\\nå¤±è´¥æ¬¡æ•°: 3/3\"
            }
          }"
          
          curl -s -X POST -H "Content-Type: application/json" -d "$MESSAGE" "$WEBHOOK_URL"
          exit 1
        fi
