name: SSH Monitor

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: SSH Health Check
      run: |
        HOST="artnests.com"
        PORT="22"
        WEBHOOK_URL="https://open.feishu.cn/open-apis/bot/v2/hook/da5b31b2-5178-4fc0-b8fe-5c69cf5e1a5d"
        FAILED_COUNT=0
        
        for i in {1..5}; do
          # TCP端口检测
          if timeout 10 nc -z "$HOST" "$PORT" >/dev/null 2>&1; then
            # SSH协议握手检测
            if echo "" | timeout 5 telnet "$HOST" "$PORT" 2>/dev/null | grep -q "SSH"; then
              echo "✅ SSH服务正常"
              exit 0
            fi
          fi
          
          FAILED_COUNT=$((FAILED_COUNT + 1))
          echo "❌ 检测失败 ($i/5)"
          
          # 每次失败后等待2分钟再重试（除了最后一次）
          [ $i -lt 5 ] && sleep 120
        done
        
        # 发送告警
        if [ $FAILED_COUNT -eq 5 ]; then
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          MESSAGE="{
            \"msg_type\": \"text\",
            \"content\": {
              \"text\": \"🚨 SSH服务异常\\n\\n状态: 连接失败\\n时间: $CURRENT_TIME\\n失败次数: 5/5\"
            }
          }"
          
          curl -s -X POST -H "Content-Type: application/json" -d "$MESSAGE" "$WEBHOOK_URL"
          exit 1
        fi
